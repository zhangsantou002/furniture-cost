{% extends "base.html" %}

{% block title %}成本分析 - 板式家具工艺流程管理系统{% endblock %}

{% block page_title %}成本分析报表{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button class="btn btn-primary btn-sm" id="exportReport">
        <i class="fas fa-download"></i> 导出报表
    </button>
    <button class="btn btn-success btn-sm" id="refreshData">
        <i class="fas fa-sync-alt"></i> 刷新数据
    </button>
</div>
{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        border: none;
        transition: transform 0.2s ease;
        margin-bottom: 1.5rem;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        margin-bottom: 1rem;
    }
    
    .stats-value {
        font-size: 2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .filter-group {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .filter-select {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- 统计卡片 -->
<div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="stats-value" id="totalCost">¥0.00</div>
            <div class="stats-label">总成本</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stats-value" id="materialCost">¥0.00</div>
            <div class="stats-label">材料成本</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="fas fa-users"></i>
            </div>
            <div class="stats-value" id="laborCost">¥0.00</div>
            <div class="stats-label">人工成本</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="stats-value" id="machineCost">¥0.00</div>
            <div class="stats-label">设备成本</div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <div class="col-xl-8">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">成本趋势分析</h5>
                <div class="filter-group">
                    <select class="filter-select" id="timeRange">
                        <option value="7">最近7天</option>
                        <option value="30" selected>最近30天</option>
                        <option value="90">最近90天</option>
                        <option value="365">最近一年</option>
                    </select>
                </div>
            </div>
            <canvas id="costTrendChart" height="100"></canvas>
        </div>
    </div>
    
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">成本结构分析</h5>
            </div>
            <canvas id="costStructureChart" height="200"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">工艺节点成本对比</h5>
                <div class="filter-group">
                    <select class="filter-select" id="nodeTypeFilter">
                        <option value="">全部节点</option>
                        <option value="cutting">切割</option>
                        <option value="edge-banding">封边</option>
                        <option value="drilling">打孔</option>
                        <option value="assembly">组装</option>
                        <option value="packaging">包装</option>
                        <option value="quality-check">质检</option>
                    </select>
                </div>
            </div>
            <canvas id="nodeCostChart" height="150"></canvas>
        </div>
    </div>
    
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">产品系列成本分布</h5>
            </div>
            <canvas id="seriesCostChart" height="150"></canvas>
        </div>
    </div>
</div>

<!-- 详细数据表格 -->
<div class="row">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">成本明细表</h5>
                <div class="filter-group">
                    <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="搜索...">
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="costDetailTable">
                    <thead class="table-light">
                        <tr>
                            <th>日期</th>
                            <th>产品系列</th>
                            <th>工艺节点</th>
                            <th>材料成本</th>
                            <th>人工成本</th>
                            <th>设备成本</th>
                            <th>总成本</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <p>暂无成本数据</p>
                                <p class="small">请先创建工艺流程并计算成本</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 初始化图表
    initializeCharts();
    
    // 绑定事件
    $('#exportReport').click(function() {
        alert('导出报表功能待实现');
    });
    
    $('#refreshData').click(function() {
        location.reload();
    });
    
    $('#timeRange').change(function() {
        updateCharts();
    });
    
    $('#nodeTypeFilter').change(function() {
        updateNodeCostChart();
    });
    
    $('#searchInput').on('input', function() {
        filterTable();
    });
});

function initializeCharts() {
    // 成本趋势图
    const trendCtx = document.getElementById('costTrendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
            datasets: [{
                label: '总成本',
                data: [1200, 1900, 3000, 5000, 2000, 3000],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // 成本结构饼图
    const structureCtx = document.getElementById('costStructureChart').getContext('2d');
    const structureChart = new Chart(structureCtx, {
        type: 'doughnut',
        data: {
            labels: ['材料成本', '人工成本', '设备成本', '间接成本'],
            datasets: [{
                data: [40, 30, 20, 10],
                backgroundColor: [
                    '#667eea',
                    '#f093fb',
                    '#4facfe',
                    '#43e97b'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
    
    // 工艺节点成本对比图
    const nodeCtx = document.getElementById('nodeCostChart').getContext('2d');
    const nodeChart = new Chart(nodeCtx, {
        type: 'bar',
        data: {
            labels: ['切割', '封边', '打孔', '组装', '包装', '质检'],
            datasets: [{
                label: '成本',
                data: [300, 250, 200, 400, 150, 100],
                backgroundColor: [
                    '#ff4d4f',
                    '#fa8c16',
                    '#faad14',
                    '#52c41a',
                    '#1890ff',
                    '#722ed1'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // 产品系列成本分布图
    const seriesCtx = document.getElementById('seriesCostChart').getContext('2d');
    const seriesChart = new Chart(seriesCtx, {
        type: 'bar',
        data: {
            labels: ['Zina系列', 'Wivor系列', '其他系列'],
            datasets: [{
                label: '成本',
                data: [800, 600, 400],
                backgroundColor: [
                    '#667eea',
                    '#f093fb',
                    '#4facfe'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateCharts() {
    // 更新图表的逻辑
    console.log('更新图表数据...');
}

function updateNodeCostChart() {
    // 更新节点成本图表的逻辑
    console.log('更新节点成本图表...');
}

function filterTable() {
    // 过滤表格的逻辑
    console.log('过滤表格数据...');
}
</script>
{% endblock %}